<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drag</title>
    <style>
      body,
      html {
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      .container {
        position: relative;
        height: 100%;
        width: 100%;
        background: gray;
      }
      .drag {
        height: 100px;
        width: 100px;
        background: white;
        z-index: 0;
      }
      .select {
        opacity: 0.6;
        z-index: 999;
      }
      .box {
        height: 500px;
        width: 500px;
        position: absolute;
        right: calc(50% - 250px);
        top: 0;
        background: black;
      }
      .clear {
        position: absolute;
        right: calc(50%);
        top: 0;
      }
    </style>
  </head>
  <body>
    <script defer>
      // 拖动事件处理
      const drag = {
        box: null,
        dragstart: (event) => {
          // 为容器注册拖动处理事件
          drag.box.addEventListener("dragenter", drag.dargEnter);
          drag.box.addEventListener("dragover", drag.dragOver);
          drag.box.addEventListener("dragleave", drag.dragLeave);
          drag.box.addEventListener("drop", drag.dropElement);
        },
        dragEnd: (event) => {
          // 为容器注销拖动处理事件
          drag.box.removeEventListener("dragenter", drag.dargEnter);
          drag.box.removeEventListener("dragover", drag.dragOver);
          drag.box.removeEventListener("dragleave", drag.dragLeave);
          drag.box.removeEventListener("drop", drag.dropElement);
        },
        dargEnter: (event) => {
          // 修改拖动的类型（这里会改变鼠标样式）
          event.dataTransfer.dropEffect = "move";
        },
        dragOver: (event) => {
          // 阻止其他事件
          event.preventDefault();
        },
        dragLeave: (event) => {
          // 修改拖动的类型（这里会改变鼠标样式）
          event.dataTransfer.dropEffect = "none";
        },
        dropElement: (event) => {
          const clone = document
              .getElementsByClassName("drag")[0]
              .cloneNode(true);
          drag.box.appendChild(clone);
          let offsetX = Math.max(
              0,
              event.layerX - Math.floor(clone.clientWidth / 2)
            ),
            offsetY = Math.max(
              0,
              event.layerY - Math.floor(clone.clientHeight / 2)
            );
          clone.style.left = `${offsetX}px`;
          clone.style.top = `${offsetY}px`;
          clone.style.position = "absolute";
          clone.removeAttribute('draggable');
          clone.addEventListener('mousedown', move.mouseDown);
          move.box = drag.box;
        },
      };
      // 在画布中移动元素事件处理
      const move = {
        position: null,
        box: null,
        mouseDown: (event) => {
          event.target.className += ' select';
          startX = event.clientX;
          startY = event.clientY;
          currX = parseInt(event.target.style.left.replace('px', ''));
          currY = parseInt(event.target.style.top.replace('px', ''));
          move.position = new Proxy({
            startX: startX,
            startY: startY,
            currX: currX,
            currY: currY,
            clientX: 0,
            clientY: 0
          }, {
            set(target, property, value) {
              if (property === 'clientX') {
                event.target.style.left = `${Math.max(value - target.startX + target.currX, 0)}px`;
              }
              if (property === 'clientY') {
                event.target.style.top = `${Math.max(value - target.startY + target.currY, 0)}px`;
              }
            }
          })
          move.box.addEventListener('mousemove', move.mouseMove);
          move.box.addEventListener('mouseup', move.mouseUp);
          move.box.addEventListener('mouseleave', move.mouseUp);
        },
        mouseMove: (event) => {
          move.position.clientX = event.clientX;
          move.position.clientY = event.clientY;
        },
        mouseUp: (event) => {
          event.target.className = event.target.className.replace(' select', '');
          move.box.removeEventListener('mousemove', move.mouseMove);
          move.box.removeEventListener('mouseup', move.mouseUp);
          move.box.removeEventListener('mouseleave', move.mouseUp);
        },
        mouseLeave: (event) => {
          move.mouseUp(event)
        }
      };
      // 为被拖拽元素绑定事件。
      window.onload = function () {
        const dragElem = document.getElementsByClassName("drag")[0];
        dragElem.addEventListener("dragstart", drag.dragstart);
        dragElem.addEventListener("dragend", drag.dragEnd);
        drag.box = document.getElementsByClassName("box")[0];
        move.box = drag.box;
      };
    </script>
    <div class="container">
      <div class="drag" draggable="true"></div>
      <div class="box"></div>
      <button
        class="clear"
        onclick="document.getElementsByClassName('box')[0].innerHTML = ''"
      >
        clear
      </button>
    </div>
  </body>
</html>
